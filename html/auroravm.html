<html>
<head>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<title>Aurora Virtual Machine</title>
<style>
body {
    width: 60%;
    min-width: 800px;
    margin: 10px auto;
    font-family: -apple-system, BlinkMacSystemFont, Microsoft YaHei, "宋体", "Helvetica Neue", Helvetica, Arial, sans-serif;
}
* {
    outline: none;
}
a {
    color: inherit;
    text-decoration: underline;
}
a:hover {
    color: #00a4e6;
    text-decoration: underline;
}
button {
    line-height:0px;
    height:30px;
    font-size: 14px;
    border: none;
    border-radius: 5px;
    background: #00a4e6;
    color:aliceblue;
    padding: 3px 10px 3px 10px;
}
button:hover {
    background: #0199d4;
}
.testcase {
    color: #0199d4;
    font-weight: bold;
    cursor: pointer;
}

.selected {
    color: #ffaeae;
}

.code {
    width: 300px;
}
.lineNum {
    color: #aaaaaa;
    display: inline-block;
    text-align: right;
    width: 20px;
    margin-right: 15px;
}
p {
    margin: 2px;
}
table {
    border-collapse: collapse;
    border-spacing: 2px;
}
td, th {
    min-width: 30px;
    border: 1px solid #dddddd;
    vertical-align: top;
    font-size: 12px;
    font-family: monospace;
    padding: 5px;
    text-align: left;
}
th {
    vertical-align: middle;
    font-size: 13px;
    font-weight: bold;
}
.closureTable {
    border: 2px solid #dddddd;
    margin: 3px 0;
}
.closureTable td{
    min-width: 20px;
    padding: 1px 2px;
    text-align: center;
}
.envSymbol,.envValue{
    background-color: lightskyblue;
}
.envSymbol{
    font-weight: bold;
}
.upvaluesSymbol,.upvaluesValue{
    background-color:pink;
}
.upvaluesSymbol{
    font-weight: bold;
}
hr {
    border: none;
    border-top: 2px solid #15e;
}
</style>
</head>
<body>
<div style="font-size: 20px; font-weight: bold; line-height: 25px;">AuroraVM (Archived) <i style="color:#cccccc; font-size: 13px;">v0.1 alpha</i></div>
<div style="font-size: 10px; color: #dbdbdb;">最新：2019.03.08</div>
<div style="font-size: 10px; color: #dbdbdb;">正在重构的NodeJS版本：<a href="https://github.com/bd4sur/Animach">GitHub Repo</a></div>
<div style="font-size: 13px; line-height: 18px; margin: 10px 0; color: #aaaaaa;">
    基于栈的虚拟机。特性：<br>
    ● 基本算术逻辑运算、表操作。<br>
    ● 支持一等函数，基于闭包实现。<br>
    ● 多进程并发（无优先级的时间片轮转）。<br>
    ● 基于标记-清除算法的自动垃圾回收。<br>
    ● 一等continuation和<code>call/cc</code>。<br>
</div>
<div style="font-size: 13px; margin: 10px 0;">
<!-- <strong>选择测试用例</strong>：
<span class="testcase selected" id="case0">普通阶乘</span> / <span class="testcase" id="case1">词法作用域</span> / <span class="testcase" id="case2">CPS阶乘</span> / <span class="testcase" id="case3">ManOrBoyTest</span> / <span class="testcase" id="case4">尾递归阶乘</span>
</div> -->
<div style="margin: 5px 0;">
    <button id="reset" style="background-color: #f58;">复位</button>
    <button id="onestep">单步步进(F9)</button>
    <button id="stepbystep">连续步进</button>
    <button id="execute" style="background-color: rgb(0, 180, 0);">不调试执行</button>
</div>

<div id="output" style="line-height: 20px; background: #eeeeee; color:#111111; border-radius: 5px; padding:5px 8px; margin: 10px 0; font-size: 13px; overflow-wrap: break-word; font-family: Menlo,Monaco,Consolas,monospace;-webkit-font-smoothing: antialiased;"></div>

<div style="font-size:13px;font-weight:bold;">当前TID：<span id="tid" style="color:red;"></span></div>

<table>
    <tr><th>虚拟机指令</th><th>函数调用栈</th><th>操作数栈</th><th>闭包</th><th>存储布局(<span style="color:#00dddd;">池</span>/<span style="color:#dddd00;">堆</span>)</th></tr>
    <tr>
        <td><code class="code" id="asm"></code></td>
        <td id="fstack"></td>
        <td id="opstack"></td>
        <td id="closures"></td>
        <td id="heap"></td>
    </tr>
</table>
<hr>
<div style="font-size: 13px; color: #aaaaaa; margin: 5px 0;">技术细节参见《<a href="https://bd4sur.com/#/blog/PL-Scheme%E7%BC%96%E8%AF%91%E5%99%A8%E8%AE%BE%E8%AE%A1%E7%AC%94%E8%AE%B0">设计笔记</a>》</div>
<div style="font-size: 13px; color: #aaaaaa; margin: 5px 0;">&copy; 2019 bd4sur.com</div>

<script src="../script/auroravm.js"></script>
<script>
var asmcode = [
// 0 普通递归（阶乘）
``,
// 1 闭包和set!
``,
// 2 MoB测试
``,
// 3 尾递归
`
;(define fac
;  (lambda (n p)
;    (if (= n 0)
;        p
;        (fac (- n 1) (* n p)))))
;(fac 8 1)

@start
goto @main

@fac
store &p
store &n
load &n
push 0
=
iftrue @initval
load &n
push 1
-
load &n
load &p
*
tailcall &fac
return
@initval
load &p
return

@main
push "尾递归测试"
display
newline

push "8!="
display

push @fac
store &fac
push 8
push 1
call &fac
display
newline
halt

`,
// 4 列表和字符串（静态资源）
``,
// 5 simple call/cc
`
;; (+ 1 (call/cc (lambda (return) (* 2 (return 3)..)

push 1
capturecc &return
push 2
push 3
call &return
*
@&return
+
display
halt
`,

// 6 Yin-yang puzzle (first-class continuation)
``,
// 7 列表和字符串（GC和cons测试）
``,
];


function InitTestEnv() {
    let avm = new AuroraVM();
    avm.AddDebuggerRenderer(Render);
    avm.AddOutput(output);

    // 普通阶乘
    let testcase0 = {"qualifiedName":"aurora.testcase.factorial","name":"factorial","AST":{"variables":["fac","n"],"symbols":[],"strings":["\"【SSC编译】普通阶乘 10!=\""],"slists":[{"type":"SLIST","index":0,"children":["$1"],"isQuoted":false,"parameters":[],"body":null},{"type":"LAMBDA","index":1,"parentIndex":0,"children":[],"isQuoted":false,"parameters":[],"body":"$2"},{"type":"SLIST","index":2,"parentIndex":1,"children":["begin","$3","$10","$11","$13"],"isQuoted":false,"parameters":[],"body":null},{"type":"SLIST","index":3,"parentIndex":2,"children":["define","&0","$4"],"isQuoted":false,"parameters":[],"body":null},{"type":"LAMBDA","index":4,"parentIndex":3,"children":[],"isQuoted":false,"parameters":["&1"],"body":"$5"},{"type":"SLIST","index":5,"parentIndex":4,"children":["if","$6","#1","$7"],"isQuoted":false,"parameters":[],"body":null},{"type":"SLIST","index":6,"parentIndex":5,"children":["=","&1","#0"],"isQuoted":false,"parameters":[],"body":null},{"type":"SLIST","index":7,"parentIndex":5,"children":["*","&1","$8"],"isQuoted":false,"parameters":[],"body":null},{"type":"SLIST","index":8,"parentIndex":7,"children":["&0","$9"],"isQuoted":false,"parameters":[],"body":null},{"type":"SLIST","index":9,"parentIndex":8,"children":["-","&1","#2"],"isQuoted":false,"parameters":[],"body":null},{"type":"SLIST","index":10,"parentIndex":2,"children":["display","*0"],"isQuoted":false,"parameters":[],"body":null},{"type":"SLIST","index":11,"parentIndex":2,"children":["display","$12"],"isQuoted":false,"parameters":[],"body":null},{"type":"SLIST","index":12,"parentIndex":11,"children":["&0","#3"],"isQuoted":false,"parameters":[],"body":null},{"type":"SLIST","index":13,"parentIndex":2,"children":["newline"],"isQuoted":false,"parameters":[],"body":null}],"constants":["0","1","1","10"],"refIndexes":{"*":1,"$":14,"!":0,"&":2,"#":4,"^":0}},"ASM":["call @$1","halt",";; [SSC] Function @ $1","@$1",";; [SSC] DEFINE","push @$4","store &0","push *0","display","push #3","call &0","display","newline","return",";; [SSC] Function @ $4","@$4","store &1",";; [SSC] IF","load &1","push #0","=","iftrue @IF-TRUE-TEMP0","load &1","load &1","push #2","-","call &0","*","goto @END-IF-TEMP1","@IF-TRUE-TEMP0","push #1","@END-IF-TEMP1","return"],"labelDict":{"@$1":3,"@$4":15,"@IF-TRUE-TEMP0":29,"@END-IF-TEMP1":31}};

    // CPS阶乘/set!
    let testcase1 = {"qualifiedName":"aurora.testcase.factorial-cps","name":"factorial-cps","AST":{"variables":["fac-count","clo-count","fac","n","cont","res","x"],"symbols":[],"strings":["\"【SSC编译】CPS阶乘/set!测试 5!=\"","\"闭包调用次数=\"","\"阶乘递归调用次数=\""],"slists":[{"type":"SLIST","index":0,"children":["$1"],"isQuoted":false,"parameters":[],"body":null},{"type":"LAMBDA","index":1,"parentIndex":0,"children":[],"isQuoted":false,"parameters":[],"body":"$2"},{"type":"SLIST","index":2,"parentIndex":1,"children":["begin","$3","$4","$5","$21","$22","$25","$26","$27","$28","$29","$30","$31"],"isQuoted":false,"parameters":[],"body":null},{"type":"SLIST","index":3,"parentIndex":2,"children":["define","&0","#0"],"isQuoted":false,"parameters":[],"body":null},{"type":"SLIST","index":4,"parentIndex":2,"children":["define","&1","#1"],"isQuoted":false,"parameters":[],"body":null},{"type":"SLIST","index":5,"parentIndex":2,"children":["define","&2","$6"],"isQuoted":false,"parameters":[],"body":null},{"type":"LAMBDA","index":6,"parentIndex":5,"children":[],"isQuoted":false,"parameters":["&3","&4"],"body":"$7"},{"type":"SLIST","index":7,"parentIndex":6,"children":["begin","$8","$10"],"isQuoted":false,"parameters":[],"body":null},{"type":"SLIST","index":8,"parentIndex":7,"children":["set!","&0","$9"],"isQuoted":false,"parameters":[],"body":null},{"type":"SLIST","index":9,"parentIndex":8,"children":["+","&0","#2"],"isQuoted":false,"parameters":[],"body":null},{"type":"SLIST","index":10,"parentIndex":7,"children":["if","$11","$12","$13"],"isQuoted":false,"parameters":[],"body":null},{"type":"SLIST","index":11,"parentIndex":10,"children":["=","&3","#3"],"isQuoted":false,"parameters":[],"body":null},{"type":"SLIST","index":12,"parentIndex":10,"children":["&4","#4"],"isQuoted":false,"parameters":[],"body":null},{"type":"SLIST","index":13,"parentIndex":10,"children":["&2","$14","$15"],"isQuoted":false,"parameters":[],"body":null},{"type":"SLIST","index":14,"parentIndex":13,"children":["-","&3","#5"],"isQuoted":false,"parameters":[],"body":null},{"type":"LAMBDA","index":15,"parentIndex":13,"children":[],"isQuoted":false,"parameters":["&5"],"body":"$16"},{"type":"SLIST","index":16,"parentIndex":15,"children":["begin","$17","$19"],"isQuoted":false,"parameters":[],"body":null},{"type":"SLIST","index":17,"parentIndex":16,"children":["set!","&1","$18"],"isQuoted":false,"parameters":[],"body":null},{"type":"SLIST","index":18,"parentIndex":17,"children":["+","&1","#6"],"isQuoted":false,"parameters":[],"body":null},{"type":"SLIST","index":19,"parentIndex":16,"children":["&4","$20"],"isQuoted":false,"parameters":[],"body":null},{"type":"SLIST","index":20,"parentIndex":19,"children":["*","&5","&3"],"isQuoted":false,"parameters":[],"body":null},{"type":"SLIST","index":21,"parentIndex":2,"children":["display","*0"],"isQuoted":false,"parameters":[],"body":null},{"type":"SLIST","index":22,"parentIndex":2,"children":["display","$23"],"isQuoted":false,"parameters":[],"body":null},{"type":"SLIST","index":23,"parentIndex":22,"children":["&2","#7","$24"],"isQuoted":false,"parameters":[],"body":null},{"type":"LAMBDA","index":24,"parentIndex":23,"children":[],"isQuoted":false,"parameters":["&6"],"body":"&6"},{"type":"SLIST","index":25,"parentIndex":2,"children":["newline"],"isQuoted":false,"parameters":[],"body":null},{"type":"SLIST","index":26,"parentIndex":2,"children":["display","*1"],"isQuoted":false,"parameters":[],"body":null},{"type":"SLIST","index":27,"parentIndex":2,"children":["display","&1"],"isQuoted":false,"parameters":[],"body":null},{"type":"SLIST","index":28,"parentIndex":2,"children":["newline"],"isQuoted":false,"parameters":[],"body":null},{"type":"SLIST","index":29,"parentIndex":2,"children":["display","*2"],"isQuoted":false,"parameters":[],"body":null},{"type":"SLIST","index":30,"parentIndex":2,"children":["display","&0"],"isQuoted":false,"parameters":[],"body":null},{"type":"SLIST","index":31,"parentIndex":2,"children":["newline"],"isQuoted":false,"parameters":[],"body":null}],"constants":["0","0","1","0","1","1","1","5"],"refIndexes":{"*":3,"$":32,"!":0,"&":7,"#":8,"^":0}},"ASM":["call @$1","halt",";; [SSC] Function @ $1","@$1",";; [SSC] DEFINE","push #0","store &0",";; [SSC] DEFINE","push #1","store &1",";; [SSC] DEFINE","push @$6","store &2","push *0","display","push #7","load @$24","call &2","display","newline","push *1","display","load &1","display","newline","push *2","display","load &0","display","newline","return",";; [SSC] Function @ $6","@$6","store &4","store &3",";; [SSC] SET!","load &0","push #2","+","set! &0",";; [SSC] IF","load &3","push #3","=","iftrue @IF-TRUE-TEMP0","load &3","push #5","-","load @$15","call &2","goto @END-IF-TEMP1","@IF-TRUE-TEMP0","push #4","call &4","@END-IF-TEMP1","return",";; [SSC] Function @ $15","@$15","store &5",";; [SSC] SET!","load &1","push #6","+","set! &1","load &5","load &3","*","call &4","return",";; [SSC] Function @ $24","@$24","store &6","load &6","return"],"labelDict":{"@$1":3,"@$6":32,"@IF-TRUE-TEMP0":51,"@END-IF-TEMP1":54,"@$15":57,"@$24":70}};

    // Man Or Boy Test
    let testcase2 = {"qualifiedName":"aurora.testcase.man-or-boy-test","name":"man-or-boy-test","AST":{"variables":["A","k","x1","x2","x3","x4","x5","B"],"symbols":[],"strings":["\"【SSC编译】Man or Boy Test = \""],"slists":[{"type":"SLIST","index":0,"children":["$1"],"isQuoted":false,"parameters":[],"body":null},{"type":"LAMBDA","index":1,"parentIndex":0,"children":[],"isQuoted":false,"parameters":[],"body":"$2"},{"type":"SLIST","index":2,"parentIndex":1,"children":["begin","$3","$18","$19","$26"],"isQuoted":false,"parameters":[],"body":null},{"type":"SLIST","index":3,"parentIndex":2,"children":["define","&0","$4"],"isQuoted":false,"parameters":[],"body":null},{"type":"LAMBDA","index":4,"parentIndex":3,"children":[],"isQuoted":false,"parameters":["&1","&2","&3","&4","&5","&6"],"body":"$5"},{"type":"SLIST","index":5,"parentIndex":4,"children":["begin","$6","$12"],"isQuoted":false,"parameters":[],"body":null},{"type":"SLIST","index":6,"parentIndex":5,"children":["define","&7","$7"],"isQuoted":false,"parameters":[],"body":null},{"type":"LAMBDA","index":7,"parentIndex":6,"children":[],"isQuoted":false,"parameters":[],"body":"$8"},{"type":"SLIST","index":8,"parentIndex":7,"children":["begin","$9","$11"],"isQuoted":false,"parameters":[],"body":null},{"type":"SLIST","index":9,"parentIndex":8,"children":["set!","&1","$10"],"isQuoted":false,"parameters":[],"body":null},{"type":"SLIST","index":10,"parentIndex":9,"children":["-","&1","#0"],"isQuoted":false,"parameters":[],"body":null},{"type":"SLIST","index":11,"parentIndex":8,"children":["&0","&1","&7","&2","&3","&4","&5"],"isQuoted":false,"parameters":[],"body":null},{"type":"SLIST","index":12,"parentIndex":5,"children":["if","$13","$14","$17"],"isQuoted":false,"parameters":[],"body":null},{"type":"SLIST","index":13,"parentIndex":12,"children":["<=","&1","#1"],"isQuoted":false,"parameters":[],"body":null},{"type":"SLIST","index":14,"parentIndex":12,"children":["+","$15","$16"],"isQuoted":false,"parameters":[],"body":null},{"type":"SLIST","index":15,"parentIndex":14,"children":["&5"],"isQuoted":false,"parameters":[],"body":null},{"type":"SLIST","index":16,"parentIndex":14,"children":["&6"],"isQuoted":false,"parameters":[],"body":null},{"type":"SLIST","index":17,"parentIndex":12,"children":["&7"],"isQuoted":false,"parameters":[],"body":null},{"type":"SLIST","index":18,"parentIndex":2,"children":["display","*0"],"isQuoted":false,"parameters":[],"body":null},{"type":"SLIST","index":19,"parentIndex":2,"children":["display","$20"],"isQuoted":false,"parameters":[],"body":null},{"type":"SLIST","index":20,"parentIndex":19,"children":["&0","#2","$21","$22","$23","$24","$25"],"isQuoted":false,"parameters":[],"body":null},{"type":"LAMBDA","index":21,"parentIndex":20,"children":[],"isQuoted":false,"parameters":[],"body":"1"},{"type":"LAMBDA","index":22,"parentIndex":20,"children":[],"isQuoted":false,"parameters":[],"body":"-1"},{"type":"LAMBDA","index":23,"parentIndex":20,"children":[],"isQuoted":false,"parameters":[],"body":"-1"},{"type":"LAMBDA","index":24,"parentIndex":20,"children":[],"isQuoted":false,"parameters":[],"body":"1"},{"type":"LAMBDA","index":25,"parentIndex":20,"children":[],"isQuoted":false,"parameters":[],"body":"0"},{"type":"SLIST","index":26,"parentIndex":2,"children":["newline"],"isQuoted":false,"parameters":[],"body":null}],"constants":["1","0","10"],"refIndexes":{"*":1,"$":27,"!":0,"&":8,"#":3,"^":0}},"ASM":["call @$1","halt",";; [SSC] Function @ $1","@$1",";; [SSC] DEFINE","push @$4","store &0","push *0","display","push #2","load @$21","load @$22","load @$23","load @$24","load @$25","call &0","display","newline","return",";; [SSC] Function @ $4","@$4","store &6","store &5","store &4","store &3","store &2","store &1",";; [SSC] DEFINE","push @$7","store &7",";; [SSC] IF","load &1","push #1","<=","iftrue @IF-TRUE-TEMP0","call &7","goto @END-IF-TEMP1","@IF-TRUE-TEMP0","call &5","call &6","+","@END-IF-TEMP1","return",";; [SSC] Function @ $7","@$7",";; [SSC] SET!","load &1","push #0","-","set! &1","load &1","load &7","load &2","load &3","load &4","load &5","call &0","return",";; [SSC] Function @ $21","@$21","push 1","return",";; [SSC] Function @ $22","@$22","push -1","return",";; [SSC] Function @ $23","@$23","push -1","return",";; [SSC] Function @ $24","@$24","push 1","return",";; [SSC] Function @ $25","@$25","push 0","return"],"labelDict":{"@$1":3,"@$4":20,"@IF-TRUE-TEMP0":37,"@END-IF-TEMP1":41,"@$7":44,"@$21":59,"@$22":63,"@$23":67,"@$24":71,"@$25":75}};

    // 纯CPS阶乘
    let testcase3 = {"qualifiedName":"aurora.testcase.factorial-purecps","name":"factorial-purecps","AST":{"variables":["fac-cps","cont","n","k","cont","cont","cont","x","y","k","node0","res","p-res","cont","cont","cont","x","y","k","node0","node1","cont","x","y","k","node2","res2","res1","res","m","x","x"],"symbols":[],"strings":["\"【SSC编译】真·CPS阶乘：10!=\""],"slists":[{"type":"SLIST","index":0,"children":["$1"],"isQuoted":false,"parameters":[],"body":null},{"type":"LAMBDA","index":1,"parentIndex":0,"children":[],"isQuoted":false,"parameters":[],"body":"$2"},{"type":"SLIST","index":2,"parentIndex":1,"children":["begin","$3","$61","$62","$68"],"isQuoted":false,"parameters":[],"body":null},{"type":"SLIST","index":3,"parentIndex":2,"children":["define","&0","$4"],"isQuoted":false,"parameters":[],"body":null},{"type":"LAMBDA","index":4,"parentIndex":3,"children":[],"isQuoted":false,"parameters":["&1"],"body":"$5"},{"type":"SLIST","index":5,"parentIndex":4,"children":["&1","$6"],"isQuoted":false,"parameters":[],"body":null},{"type":"LAMBDA","index":6,"parentIndex":5,"children":[],"isQuoted":false,"parameters":["&2"],"body":"$7"},{"type":"LAMBDA","index":7,"parentIndex":6,"children":[],"isQuoted":false,"parameters":["&3"],"body":"$8"},{"type":"SLIST","index":8,"parentIndex":7,"children":["$9","$59"],"isQuoted":false,"parameters":[],"body":null},{"type":"LAMBDA","index":9,"parentIndex":8,"children":[],"isQuoted":false,"parameters":["&4"],"body":"$10"},{"type":"SLIST","index":10,"parentIndex":9,"children":["$11","$24"],"isQuoted":false,"parameters":[],"body":null},{"type":"LAMBDA","index":11,"parentIndex":10,"children":[],"isQuoted":false,"parameters":["&5"],"body":"$12"},{"type":"SLIST","index":12,"parentIndex":11,"children":["$13","$19"],"isQuoted":false,"parameters":[],"body":null},{"type":"LAMBDA","index":13,"parentIndex":12,"children":[],"isQuoted":false,"parameters":["&6"],"body":"$14"},{"type":"SLIST","index":14,"parentIndex":13,"children":["&6","$15"],"isQuoted":false,"parameters":[],"body":null},{"type":"LAMBDA","index":15,"parentIndex":14,"children":[],"isQuoted":false,"parameters":["&7","&8"],"body":"$16"},{"type":"LAMBDA","index":16,"parentIndex":15,"children":[],"isQuoted":false,"parameters":["&9"],"body":"$17"},{"type":"SLIST","index":17,"parentIndex":16,"children":["&9","$18"],"isQuoted":false,"parameters":[],"body":null},{"type":"SLIST","index":18,"parentIndex":17,"children":["=","&7","&8"],"isQuoted":false,"parameters":[],"body":null},{"type":"LAMBDA","index":19,"parentIndex":12,"children":[],"isQuoted":false,"parameters":["&10"],"body":"$20"},{"type":"SLIST","index":20,"parentIndex":19,"children":["$21","$22"],"isQuoted":false,"parameters":[],"body":null},{"type":"SLIST","index":21,"parentIndex":20,"children":["&10","#0","&2"],"isQuoted":false,"parameters":[],"body":null},{"type":"LAMBDA","index":22,"parentIndex":20,"children":[],"isQuoted":false,"parameters":["&11"],"body":"$23"},{"type":"SLIST","index":23,"parentIndex":22,"children":["&5","&11"],"isQuoted":false,"parameters":[],"body":null},{"type":"LAMBDA","index":24,"parentIndex":10,"children":[],"isQuoted":false,"parameters":["&12"],"body":"$25"},{"type":"SLIST","index":25,"parentIndex":24,"children":["if","&12","$26","$29"],"isQuoted":false,"parameters":[],"body":null},{"type":"SLIST","index":26,"parentIndex":25,"children":["$27","&4"],"isQuoted":false,"parameters":[],"body":null},{"type":"LAMBDA","index":27,"parentIndex":26,"children":[],"isQuoted":false,"parameters":["&13"],"body":"$28"},{"type":"SLIST","index":28,"parentIndex":27,"children":["&13","#1"],"isQuoted":false,"parameters":[],"body":null},{"type":"SLIST","index":29,"parentIndex":25,"children":["$30","&4"],"isQuoted":false,"parameters":[],"body":null},{"type":"LAMBDA","index":30,"parentIndex":29,"children":[],"isQuoted":false,"parameters":["&14"],"body":"$31"},{"type":"SLIST","index":31,"parentIndex":30,"children":["$32","$38"],"isQuoted":false,"parameters":[],"body":null},{"type":"LAMBDA","index":32,"parentIndex":31,"children":[],"isQuoted":false,"parameters":["&15"],"body":"$33"},{"type":"SLIST","index":33,"parentIndex":32,"children":["&15","$34"],"isQuoted":false,"parameters":[],"body":null},{"type":"LAMBDA","index":34,"parentIndex":33,"children":[],"isQuoted":false,"parameters":["&16","&17"],"body":"$35"},{"type":"LAMBDA","index":35,"parentIndex":34,"children":[],"isQuoted":false,"parameters":["&18"],"body":"$36"},{"type":"SLIST","index":36,"parentIndex":35,"children":["&18","$37"],"isQuoted":false,"parameters":[],"body":null},{"type":"SLIST","index":37,"parentIndex":36,"children":["*","&16","&17"],"isQuoted":false,"parameters":[],"body":null},{"type":"LAMBDA","index":38,"parentIndex":31,"children":[],"isQuoted":false,"parameters":["&19"],"body":"$39"},{"type":"SLIST","index":39,"parentIndex":38,"children":["&0","$40"],"isQuoted":false,"parameters":[],"body":null},{"type":"LAMBDA","index":40,"parentIndex":39,"children":[],"isQuoted":false,"parameters":["&20"],"body":"$41"},{"type":"SLIST","index":41,"parentIndex":40,"children":["$42","$48"],"isQuoted":false,"parameters":[],"body":null},{"type":"LAMBDA","index":42,"parentIndex":41,"children":[],"isQuoted":false,"parameters":["&21"],"body":"$43"},{"type":"SLIST","index":43,"parentIndex":42,"children":["&21","$44"],"isQuoted":false,"parameters":[],"body":null},{"type":"LAMBDA","index":44,"parentIndex":43,"children":[],"isQuoted":false,"parameters":["&22","&23"],"body":"$45"},{"type":"LAMBDA","index":45,"parentIndex":44,"children":[],"isQuoted":false,"parameters":["&24"],"body":"$46"},{"type":"SLIST","index":46,"parentIndex":45,"children":["&24","$47"],"isQuoted":false,"parameters":[],"body":null},{"type":"SLIST","index":47,"parentIndex":46,"children":["-","&22","&23"],"isQuoted":false,"parameters":[],"body":null},{"type":"LAMBDA","index":48,"parentIndex":41,"children":[],"isQuoted":false,"parameters":["&25"],"body":"$49"},{"type":"SLIST","index":49,"parentIndex":48,"children":["$50","$51"],"isQuoted":false,"parameters":[],"body":null},{"type":"SLIST","index":50,"parentIndex":49,"children":["&25","&2","#2"],"isQuoted":false,"parameters":[],"body":null},{"type":"LAMBDA","index":51,"parentIndex":49,"children":[],"isQuoted":false,"parameters":["&26"],"body":"$52"},{"type":"SLIST","index":52,"parentIndex":51,"children":["$53","$54"],"isQuoted":false,"parameters":[],"body":null},{"type":"SLIST","index":53,"parentIndex":52,"children":["&20","&26"],"isQuoted":false,"parameters":[],"body":null},{"type":"LAMBDA","index":54,"parentIndex":52,"children":[],"isQuoted":false,"parameters":["&27"],"body":"$55"},{"type":"SLIST","index":55,"parentIndex":54,"children":["$56","$57"],"isQuoted":false,"parameters":[],"body":null},{"type":"SLIST","index":56,"parentIndex":55,"children":["&19","&2","&27"],"isQuoted":false,"parameters":[],"body":null},{"type":"LAMBDA","index":57,"parentIndex":55,"children":[],"isQuoted":false,"parameters":["&28"],"body":"$58"},{"type":"SLIST","index":58,"parentIndex":57,"children":["&14","&28"],"isQuoted":false,"parameters":[],"body":null},{"type":"LAMBDA","index":59,"parentIndex":8,"children":[],"isQuoted":false,"parameters":["&29"],"body":"$60"},{"type":"SLIST","index":60,"parentIndex":59,"children":["&3","&29"],"isQuoted":false,"parameters":[],"body":null},{"type":"SLIST","index":61,"parentIndex":2,"children":["display","*0"],"isQuoted":false,"parameters":[],"body":null},{"type":"SLIST","index":62,"parentIndex":2,"children":["$63","$66"],"isQuoted":false,"parameters":[],"body":null},{"type":"SLIST","index":63,"parentIndex":62,"children":["$64","#3"],"isQuoted":false,"parameters":[],"body":null},{"type":"SLIST","index":64,"parentIndex":63,"children":["&0","$65"],"isQuoted":false,"parameters":[],"body":null},{"type":"LAMBDA","index":65,"parentIndex":64,"children":[],"isQuoted":false,"parameters":["&30"],"body":"&30"},{"type":"LAMBDA","index":66,"parentIndex":62,"children":[],"isQuoted":false,"parameters":["&31"],"body":"$67"},{"type":"SLIST","index":67,"parentIndex":66,"children":["display","&31"],"isQuoted":false,"parameters":[],"body":null},{"type":"SLIST","index":68,"parentIndex":2,"children":["newline"],"isQuoted":false,"parameters":[],"body":null}],"constants":["0","1","1","10"],"refIndexes":{"*":1,"$":69,"!":0,"&":32,"#":4,"^":0}},"ASM":["call @$1","halt",";; [SSC] Function @ $1","@$1",";; [SSC] DEFINE","push @$4","store &0","push *0","display","goto @APPLY-BEGIN-TEMP0",";; [SSC] Temporary Function @TEMP-LAMBDA-TEMP1","@TEMP-LAMBDA-TEMP1","store &TEMP3","store &TEMP2","load &TEMP3","tailcall &TEMP2","return",";; [SSC] Call Temporary Function @TEMP-LAMBDA-TEMP1","@APPLY-BEGIN-TEMP0",";; [SSC] Push item 0","goto @APPLY-BEGIN-TEMP4",";; [SSC] Temporary Function @TEMP-LAMBDA-TEMP5","@TEMP-LAMBDA-TEMP5","store &TEMP7","store &TEMP6","load &TEMP7","tailcall &TEMP6","return",";; [SSC] Call Temporary Function @TEMP-LAMBDA-TEMP5","@APPLY-BEGIN-TEMP4",";; [SSC] Push item 0","load @$65","call &0",";; [SSC] Push item 1","push #3","call @TEMP-LAMBDA-TEMP5","@TEMP-LAMBDA-RET-TEMP5",";; [SSC] Push item 1","load @$66","call @TEMP-LAMBDA-TEMP1","@TEMP-LAMBDA-RET-TEMP1","newline","return",";; [SSC] Function @ $4","@$4","store &1","load @$6","call &1","return",";; [SSC] Function @ $6","@$6","store &2","load @$7","return",";; [SSC] Function @ $7","@$7","store &3","load @$59","call @$9","return",";; [SSC] Function @ $9","@$9","store &4","load @$24","call @$11","return",";; [SSC] Function @ $11","@$11","store &5","load @$19","call @$13","return",";; [SSC] Function @ $13","@$13","store &6","load @$15","call &6","return",";; [SSC] Function @ $15","@$15","store &8","store &7","load @$16","return",";; [SSC] Function @ $16","@$16","store &9","load &7","load &8","=","call &9","return",";; [SSC] Function @ $19","@$19","store &10","goto @APPLY-BEGIN-TEMP8",";; [SSC] Temporary Function @TEMP-LAMBDA-TEMP9","@TEMP-LAMBDA-TEMP9","store &TEMP11","store &TEMP10","load &TEMP11","tailcall &TEMP10","return",";; [SSC] Call Temporary Function @TEMP-LAMBDA-TEMP9","@APPLY-BEGIN-TEMP8",";; [SSC] Push item 0","push #0","load &2","call &10",";; [SSC] Push item 1","load @$22","call @TEMP-LAMBDA-TEMP9","@TEMP-LAMBDA-RET-TEMP9","return",";; [SSC] Function @ $22","@$22","store &11","load &11","call &5","return",";; [SSC] Function @ $24","@$24","store &12",";; [SSC] IF","load &12","iftrue @IF-TRUE-TEMP12","load &4","call @$30","goto @END-IF-TEMP13","@IF-TRUE-TEMP12","load &4","call @$27","@END-IF-TEMP13","return",";; [SSC] Function @ $27","@$27","store &13","push #1","call &13","return",";; [SSC] Function @ $30","@$30","store &14","load @$38","call @$32","return",";; [SSC] Function @ $32","@$32","store &15","load @$34","call &15","return",";; [SSC] Function @ $34","@$34","store &17","store &16","load @$35","return",";; [SSC] Function @ $35","@$35","store &18","load &16","load &17","*","call &18","return",";; [SSC] Function @ $38","@$38","store &19","load @$40","call &0","return",";; [SSC] Function @ $40","@$40","store &20","load @$48","call @$42","return",";; [SSC] Function @ $42","@$42","store &21","load @$44","call &21","return",";; [SSC] Function @ $44","@$44","store &23","store &22","load @$45","return",";; [SSC] Function @ $45","@$45","store &24","load &22","load &23","-","call &24","return",";; [SSC] Function @ $48","@$48","store &25","goto @APPLY-BEGIN-TEMP14",";; [SSC] Temporary Function @TEMP-LAMBDA-TEMP15","@TEMP-LAMBDA-TEMP15","store &TEMP17","store &TEMP16","load &TEMP17","tailcall &TEMP16","return",";; [SSC] Call Temporary Function @TEMP-LAMBDA-TEMP15","@APPLY-BEGIN-TEMP14",";; [SSC] Push item 0","load &2","push #2","call &25",";; [SSC] Push item 1","load @$51","call @TEMP-LAMBDA-TEMP15","@TEMP-LAMBDA-RET-TEMP15","return",";; [SSC] Function @ $51","@$51","store &26","goto @APPLY-BEGIN-TEMP18",";; [SSC] Temporary Function @TEMP-LAMBDA-TEMP19","@TEMP-LAMBDA-TEMP19","store &TEMP21","store &TEMP20","load &TEMP21","tailcall &TEMP20","return",";; [SSC] Call Temporary Function @TEMP-LAMBDA-TEMP19","@APPLY-BEGIN-TEMP18",";; [SSC] Push item 0","load &26","call &20",";; [SSC] Push item 1","load @$54","call @TEMP-LAMBDA-TEMP19","@TEMP-LAMBDA-RET-TEMP19","return",";; [SSC] Function @ $54","@$54","store &27","goto @APPLY-BEGIN-TEMP22",";; [SSC] Temporary Function @TEMP-LAMBDA-TEMP23","@TEMP-LAMBDA-TEMP23","store &TEMP25","store &TEMP24","load &TEMP25","tailcall &TEMP24","return",";; [SSC] Call Temporary Function @TEMP-LAMBDA-TEMP23","@APPLY-BEGIN-TEMP22",";; [SSC] Push item 0","load &2","load &27","call &19",";; [SSC] Push item 1","load @$57","call @TEMP-LAMBDA-TEMP23","@TEMP-LAMBDA-RET-TEMP23","return",";; [SSC] Function @ $57","@$57","store &28","load &28","call &14","return",";; [SSC] Function @ $59","@$59","store &29","load &29","call &3","return",";; [SSC] Function @ $65","@$65","store &30","load &30","return",";; [SSC] Function @ $66","@$66","store &31","load &31","display","return"],"labelDict":{"@$1":3,"@TEMP-LAMBDA-TEMP1":11,"@APPLY-BEGIN-TEMP0":18,"@TEMP-LAMBDA-TEMP5":22,"@APPLY-BEGIN-TEMP4":29,"@TEMP-LAMBDA-RET-TEMP5":36,"@TEMP-LAMBDA-RET-TEMP1":40,"@$4":44,"@$6":50,"@$7":55,"@$9":61,"@$11":67,"@$13":73,"@$15":79,"@$16":85,"@$19":93,"@TEMP-LAMBDA-TEMP9":97,"@APPLY-BEGIN-TEMP8":104,"@TEMP-LAMBDA-RET-TEMP9":112,"@$22":115,"@$24":121,"@IF-TRUE-TEMP12":129,"@END-IF-TEMP13":132,"@$27":135,"@$30":141,"@$32":147,"@$34":153,"@$35":159,"@$38":167,"@$40":173,"@$42":179,"@$44":185,"@$45":191,"@$48":199,"@TEMP-LAMBDA-TEMP15":203,"@APPLY-BEGIN-TEMP14":210,"@TEMP-LAMBDA-RET-TEMP15":218,"@$51":221,"@TEMP-LAMBDA-TEMP19":225,"@APPLY-BEGIN-TEMP18":232,"@TEMP-LAMBDA-RET-TEMP19":239,"@$54":242,"@TEMP-LAMBDA-TEMP23":246,"@APPLY-BEGIN-TEMP22":253,"@TEMP-LAMBDA-RET-TEMP23":261,"@$57":264,"@$59":270,"@$65":276,"@$66":281}};

    // call/cc generator
    let testcase4 = {"qualifiedName":"aurora.testcase.generator","name":"generator","AST":{"variables":["count","generator","g","init","Kont"],"symbols":[],"strings":["\"【SSC编译】生成器：\"","\" \""],"slists":[{"type":"SLIST","index":0,"children":["$1"],"isQuoted":false,"parameters":[],"body":null},{"type":"LAMBDA","index":1,"parentIndex":0,"children":[],"isQuoted":false,"parameters":[],"body":"$2"},{"type":"SLIST","index":2,"parentIndex":1,"children":["begin","$3","$4","$5","$16","$17","$19","$20"],"isQuoted":false,"parameters":[],"body":null},{"type":"SLIST","index":3,"parentIndex":2,"children":["define","&0","#0"],"isQuoted":false,"parameters":[],"body":null},{"type":"SLIST","index":4,"parentIndex":2,"children":["define","&1","#f"],"isQuoted":false,"parameters":[],"body":null},{"type":"SLIST","index":5,"parentIndex":2,"children":["define","&2","$6"],"isQuoted":false,"parameters":[],"body":null},{"type":"LAMBDA","index":6,"parentIndex":5,"children":[],"isQuoted":false,"parameters":[],"body":"$7"},{"type":"SLIST","index":7,"parentIndex":6,"children":["$8","#2"],"isQuoted":false,"parameters":[],"body":null},{"type":"LAMBDA","index":8,"parentIndex":7,"children":[],"isQuoted":false,"parameters":["&3"],"body":"$9"},{"type":"SLIST","index":9,"parentIndex":8,"children":["begin","$10","$13","$15","&3"],"isQuoted":false,"parameters":[],"body":null},{"type":"SLIST","index":10,"parentIndex":9,"children":["call/cc","$11"],"isQuoted":false,"parameters":[],"body":null},{"type":"LAMBDA","index":11,"parentIndex":10,"children":[],"isQuoted":false,"parameters":["&4"],"body":"$12"},{"type":"SLIST","index":12,"parentIndex":11,"children":["set!","&1","&4"],"isQuoted":false,"parameters":[],"body":null},{"type":"SLIST","index":13,"parentIndex":9,"children":["set!","&3","$14"],"isQuoted":false,"parameters":[],"body":null},{"type":"SLIST","index":14,"parentIndex":13,"children":["+","&3","#1"],"isQuoted":false,"parameters":[],"body":null},{"type":"SLIST","index":15,"parentIndex":9,"children":["set!","&0","&3"],"isQuoted":false,"parameters":[],"body":null},{"type":"SLIST","index":16,"parentIndex":2,"children":["display","*0"],"isQuoted":false,"parameters":[],"body":null},{"type":"SLIST","index":17,"parentIndex":2,"children":["display","$18"],"isQuoted":false,"parameters":[],"body":null},{"type":"SLIST","index":18,"parentIndex":17,"children":["&2"],"isQuoted":false,"parameters":[],"body":null},{"type":"SLIST","index":19,"parentIndex":2,"children":["display","*1"],"isQuoted":false,"parameters":[],"body":null},{"type":"SLIST","index":20,"parentIndex":2,"children":["if","$21","$22","$23"],"isQuoted":false,"parameters":[],"body":null},{"type":"SLIST","index":21,"parentIndex":20,"children":[">=","&0","#3"],"isQuoted":false,"parameters":[],"body":null},{"type":"SLIST","index":22,"parentIndex":20,"children":["newline"],"isQuoted":false,"parameters":[],"body":null},{"type":"SLIST","index":23,"parentIndex":20,"children":["display","$24"],"isQuoted":false,"parameters":[],"body":null},{"type":"SLIST","index":24,"parentIndex":23,"children":["&1","#4"],"isQuoted":false,"parameters":[],"body":null}],"constants":["0","1","0","10","666"],"refIndexes":{"*":2,"$":25,"!":0,"&":5,"#":5,"^":0}},"ASM":["call @$1","halt",";; [SSC] Function @ $1","@$1",";; [SSC] DEFINE","push #0","store &0",";; [SSC] DEFINE","push #f","store &1",";; [SSC] DEFINE","push @$6","store &2","push *0","display","call &2","display","push *1","display",";; [SSC] IF","load &0","push #3",">=","iftrue @IF-TRUE-TEMP0","push #4","call &1","display","goto @END-IF-TEMP1","@IF-TRUE-TEMP0","newline","@END-IF-TEMP1","return",";; [SSC] Function @ $6","@$6","push #2","call @$8","return",";; [SSC] Function @ $8","@$8","store &3",";; [SSC] Current Continuation captured, stored in &CC-$11-TEMP2","capturecc &CC-$11-TEMP2","load &CC-$11-TEMP2","call @$11","@&CC-$11-TEMP2",";; [SSC] SET!","load &3","push #1","+","set! &3",";; [SSC] SET!","load &3","set! &0","load &3","return",";; [SSC] Function @ $11","@$11","store &4",";; [SSC] SET!","load &4","set! &1","return"],"labelDict":{"@$1":3,"@IF-TRUE-TEMP0":28,"@END-IF-TEMP1":30,"@$6":33,"@$8":38,"@&CC-$11-TEMP2":44,"@$11":56}};

    // 阴阳谜题
    let testcase5 = {"qualifiedName":"aurora.testcase.yin-yang-puzzle","name":"yin-yang-puzzle","AST":{"variables":["x","k","x","k"],"symbols":[],"strings":["\"@\"","\"*\""],"slists":[{"type":"SLIST","index":0,"children":["$1"],"isQuoted":false,"parameters":[],"body":null},{"type":"LAMBDA","index":1,"parentIndex":0,"children":[],"isQuoted":false,"parameters":[],"body":"$2"},{"type":"SLIST","index":2,"parentIndex":1,"children":["begin","$3"],"isQuoted":false,"parameters":[],"body":null},{"type":"SLIST","index":3,"parentIndex":2,"children":["$4","$10"],"isQuoted":false,"parameters":[],"body":null},{"type":"SLIST","index":4,"parentIndex":3,"children":["$5","$8"],"isQuoted":false,"parameters":[],"body":null},{"type":"LAMBDA","index":5,"parentIndex":4,"children":[],"isQuoted":false,"parameters":["&0"],"body":"$6"},{"type":"SLIST","index":6,"parentIndex":5,"children":["begin","$7","&0"],"isQuoted":false,"parameters":[],"body":null},{"type":"SLIST","index":7,"parentIndex":6,"children":["display","*0"],"isQuoted":false,"parameters":[],"body":null},{"type":"SLIST","index":8,"parentIndex":4,"children":["call/cc","$9"],"isQuoted":false,"parameters":[],"body":null},{"type":"LAMBDA","index":9,"parentIndex":8,"children":[],"isQuoted":false,"parameters":["&1"],"body":"&1"},{"type":"SLIST","index":10,"parentIndex":3,"children":["$11","$14"],"isQuoted":false,"parameters":[],"body":null},{"type":"LAMBDA","index":11,"parentIndex":10,"children":[],"isQuoted":false,"parameters":["&2"],"body":"$12"},{"type":"SLIST","index":12,"parentIndex":11,"children":["begin","$13","&2"],"isQuoted":false,"parameters":[],"body":null},{"type":"SLIST","index":13,"parentIndex":12,"children":["display","*1"],"isQuoted":false,"parameters":[],"body":null},{"type":"SLIST","index":14,"parentIndex":10,"children":["call/cc","$15"],"isQuoted":false,"parameters":[],"body":null},{"type":"LAMBDA","index":15,"parentIndex":14,"children":[],"isQuoted":false,"parameters":["&3"],"body":"&3"}],"constants":[],"refIndexes":{"*":2,"$":16,"!":0,"&":4,"#":0,"^":0}},"ASM":["call @$1","halt",";; [SSC] Function @ $1","@$1","goto @APPLY-BEGIN-TEMP0",";; [SSC] Temporary Function @TEMP-LAMBDA-TEMP1","@TEMP-LAMBDA-TEMP1","store &TEMP3","store &TEMP2","load &TEMP3","tailcall &TEMP2","return",";; [SSC] Call Temporary Function @TEMP-LAMBDA-TEMP1","@APPLY-BEGIN-TEMP0",";; [SSC] Push item 0",";; [SSC] Current Continuation captured, stored in &CC-$9-TEMP4","capturecc &CC-$9-TEMP4","load &CC-$9-TEMP4","call @$9","@&CC-$9-TEMP4","call @$5",";; [SSC] Push item 1",";; [SSC] Current Continuation captured, stored in &CC-$15-TEMP5","capturecc &CC-$15-TEMP5","load &CC-$15-TEMP5","call @$15","@&CC-$15-TEMP5","call @$11","call @TEMP-LAMBDA-TEMP1","@TEMP-LAMBDA-RET-TEMP1","return",";; [SSC] Function @ $5","@$5","store &0","push *0","display","load &0","return",";; [SSC] Function @ $9","@$9","store &1","load &1","return",";; [SSC] Function @ $11","@$11","store &2","push *1","display","load &2","return",";; [SSC] Function @ $15","@$15","store &3","load &3","return"],"labelDict":{"@$1":3,"@TEMP-LAMBDA-TEMP1":6,"@APPLY-BEGIN-TEMP0":13,"@&CC-$9-TEMP4":19,"@&CC-$15-TEMP5":26,"@TEMP-LAMBDA-RET-TEMP1":29,"@$5":32,"@$9":39,"@$11":44,"@$15":51}};

    // 快速排序
    let testcase6 = {"qualifiedName":"aurora.testcase.quicksort","name":"quicksort","AST":{"variables":["filter","f","lst","concat","a","b","quicksort","array","x","x"],"symbols":[],"strings":["\"【SSC编译】快速排序：\""],"slists":[{"type":"SLIST","index":0,"children":["$1"],"isQuoted":false,"parameters":[],"body":null},{"type":"LAMBDA","index":1,"parentIndex":0,"children":[],"isQuoted":false,"parameters":[],"body":"$2"},{"type":"SLIST","index":2,"parentIndex":1,"children":["begin","$3","$17","$25","$47","$48","$51"],"isQuoted":false,"parameters":[],"body":null},{"type":"SLIST","index":3,"parentIndex":2,"children":["define","&0","$4"],"isQuoted":false,"parameters":[],"body":null},{"type":"LAMBDA","index":4,"parentIndex":3,"children":[],"isQuoted":false,"parameters":["&1","&2"],"body":"$5"},{"type":"SLIST","index":5,"parentIndex":4,"children":["if","$6","$7","$8"],"isQuoted":false,"parameters":[],"body":null},{"type":"SLIST","index":6,"parentIndex":5,"children":["null?","&2"],"isQuoted":false,"parameters":[],"body":null},{"type":"SLIST","index":7,"parentIndex":5,"children":[],"isQuoted":true,"parameters":[],"body":null},{"type":"SLIST","index":8,"parentIndex":5,"children":["if","$9","$11","$15"],"isQuoted":false,"parameters":[],"body":null},{"type":"SLIST","index":9,"parentIndex":8,"children":["&1","$10"],"isQuoted":false,"parameters":[],"body":null},{"type":"SLIST","index":10,"parentIndex":9,"children":["car","&2"],"isQuoted":false,"parameters":[],"body":null},{"type":"SLIST","index":11,"parentIndex":8,"children":["cons","$12","$13"],"isQuoted":false,"parameters":[],"body":null},{"type":"SLIST","index":12,"parentIndex":11,"children":["car","&2"],"isQuoted":false,"parameters":[],"body":null},{"type":"SLIST","index":13,"parentIndex":11,"children":["&0","&1","$14"],"isQuoted":false,"parameters":[],"body":null},{"type":"SLIST","index":14,"parentIndex":13,"children":["cdr","&2"],"isQuoted":false,"parameters":[],"body":null},{"type":"SLIST","index":15,"parentIndex":8,"children":["&0","&1","$16"],"isQuoted":false,"parameters":[],"body":null},{"type":"SLIST","index":16,"parentIndex":15,"children":["cdr","&2"],"isQuoted":false,"parameters":[],"body":null},{"type":"SLIST","index":17,"parentIndex":2,"children":["define","&3","$18"],"isQuoted":false,"parameters":[],"body":null},{"type":"LAMBDA","index":18,"parentIndex":17,"children":[],"isQuoted":false,"parameters":["&4","&5"],"body":"$19"},{"type":"SLIST","index":19,"parentIndex":18,"children":["if","$20","&5","$21"],"isQuoted":false,"parameters":[],"body":null},{"type":"SLIST","index":20,"parentIndex":19,"children":["null?","&4"],"isQuoted":false,"parameters":[],"body":null},{"type":"SLIST","index":21,"parentIndex":19,"children":["cons","$22","$23"],"isQuoted":false,"parameters":[],"body":null},{"type":"SLIST","index":22,"parentIndex":21,"children":["car","&4"],"isQuoted":false,"parameters":[],"body":null},{"type":"SLIST","index":23,"parentIndex":21,"children":["&3","$24","&5"],"isQuoted":false,"parameters":[],"body":null},{"type":"SLIST","index":24,"parentIndex":23,"children":["cdr","&4"],"isQuoted":false,"parameters":[],"body":null},{"type":"SLIST","index":25,"parentIndex":2,"children":["define","&6","$26"],"isQuoted":false,"parameters":[],"body":null},{"type":"LAMBDA","index":26,"parentIndex":25,"children":[],"isQuoted":false,"parameters":["&7"],"body":"$27"},{"type":"SLIST","index":27,"parentIndex":26,"children":["if","$28","&7","$32"],"isQuoted":false,"parameters":[],"body":null},{"type":"SLIST","index":28,"parentIndex":27,"children":["or","$29","$30"],"isQuoted":false,"parameters":[],"body":null},{"type":"SLIST","index":29,"parentIndex":28,"children":["null?","&7"],"isQuoted":false,"parameters":[],"body":null},{"type":"SLIST","index":30,"parentIndex":28,"children":["null?","$31"],"isQuoted":false,"parameters":[],"body":null},{"type":"SLIST","index":31,"parentIndex":30,"children":["cdr","&7"],"isQuoted":false,"parameters":[],"body":null},{"type":"SLIST","index":32,"parentIndex":27,"children":["&3","$33","$39"],"isQuoted":false,"parameters":[],"body":null},{"type":"SLIST","index":33,"parentIndex":32,"children":["&6","$34"],"isQuoted":false,"parameters":[],"body":null},{"type":"SLIST","index":34,"parentIndex":33,"children":["&0","$35","&7"],"isQuoted":false,"parameters":[],"body":null},{"type":"LAMBDA","index":35,"parentIndex":34,"children":[],"isQuoted":false,"parameters":["&8"],"body":"$36"},{"type":"SLIST","index":36,"parentIndex":35,"children":["if","$37","#t","#f"],"isQuoted":false,"parameters":[],"body":null},{"type":"SLIST","index":37,"parentIndex":36,"children":["<","&8","$38"],"isQuoted":false,"parameters":[],"body":null},{"type":"SLIST","index":38,"parentIndex":37,"children":["car","&7"],"isQuoted":false,"parameters":[],"body":null},{"type":"SLIST","index":39,"parentIndex":32,"children":["cons","$40","$41"],"isQuoted":false,"parameters":[],"body":null},{"type":"SLIST","index":40,"parentIndex":39,"children":["car","&7"],"isQuoted":false,"parameters":[],"body":null},{"type":"SLIST","index":41,"parentIndex":39,"children":["&6","$42"],"isQuoted":false,"parameters":[],"body":null},{"type":"SLIST","index":42,"parentIndex":41,"children":["&0","$43","&7"],"isQuoted":false,"parameters":[],"body":null},{"type":"LAMBDA","index":43,"parentIndex":42,"children":[],"isQuoted":false,"parameters":["&9"],"body":"$44"},{"type":"SLIST","index":44,"parentIndex":43,"children":["if","$45","#t","#f"],"isQuoted":false,"parameters":[],"body":null},{"type":"SLIST","index":45,"parentIndex":44,"children":[">","&9","$46"],"isQuoted":false,"parameters":[],"body":null},{"type":"SLIST","index":46,"parentIndex":45,"children":["car","&7"],"isQuoted":false,"parameters":[],"body":null},{"type":"SLIST","index":47,"parentIndex":2,"children":["display","*0"],"isQuoted":false,"parameters":[],"body":null},{"type":"SLIST","index":48,"parentIndex":2,"children":["display","$49"],"isQuoted":false,"parameters":[],"body":null},{"type":"SLIST","index":49,"parentIndex":48,"children":["&6","$50"],"isQuoted":false,"parameters":[],"body":null},{"type":"SLIST","index":50,"parentIndex":49,"children":["#0","#1","#2","#3","#4","#5","#6","#7","#8","#9","#10"],"isQuoted":true,"parameters":[],"body":null},{"type":"SLIST","index":51,"parentIndex":2,"children":["newline"],"isQuoted":false,"parameters":[],"body":null}],"constants":["5","9","1","7","5","3","0","4","6","8","2"],"refIndexes":{"*":1,"$":52,"!":0,"&":10,"#":11,"^":0}},"ASM":["call @$1","halt",";; [SSC] Function @ $1","@$1",";; [SSC] DEFINE","push @$4","store &0",";; [SSC] DEFINE","push @$18","store &3",";; [SSC] DEFINE","push @$26","store &6","push *0","display","push $50","call &6","display","newline","return",";; [SSC] Function @ $4","@$4","store &2","store &1",";; [SSC] IF","load &2","null?","iftrue @IF-TRUE-TEMP0",";; [SSC] IF","load &2","car","call &1","iftrue @IF-TRUE-TEMP2","load &1","load &2","cdr","call &0","goto @END-IF-TEMP3","@IF-TRUE-TEMP2","load &2","car","load &1","load &2","cdr","call &0","cons","@END-IF-TEMP3","goto @END-IF-TEMP1","@IF-TRUE-TEMP0","push $7","@END-IF-TEMP1","return",";; [SSC] Function @ $18","@$18","store &5","store &4",";; [SSC] IF","load &4","null?","iftrue @IF-TRUE-TEMP4","load &4","car","load &4","cdr","load &5","call &3","cons","goto @END-IF-TEMP5","@IF-TRUE-TEMP4","load &5","@END-IF-TEMP5","return",";; [SSC] Function @ $26","@$26","store &7",";; [SSC] IF",";; [SSC] OR @$28","load &7","null?","iftrue @OR-TRUE-TEMP6","load &7","cdr","null?","iftrue @OR-TRUE-TEMP6","push #f","goto @END-OR-TEMP7","@OR-TRUE-TEMP6","push #t","@END-OR-TEMP7","iftrue @IF-TRUE-TEMP8","load @$35","load &7","call &0","call &6","load &7","car","load @$43","load &7","call &0","call &6","cons","call &3","goto @END-IF-TEMP9","@IF-TRUE-TEMP8","load &7","@END-IF-TEMP9","return",";; [SSC] Function @ $35","@$35","store &8",";; [SSC] IF","load &8","load &7","car","<","iftrue @IF-TRUE-TEMP10","push #f","goto @END-IF-TEMP11","@IF-TRUE-TEMP10","push #t","@END-IF-TEMP11","return",";; [SSC] Function @ $43","@$43","store &9",";; [SSC] IF","load &9","load &7","car",">","iftrue @IF-TRUE-TEMP12","push #f","goto @END-IF-TEMP13","@IF-TRUE-TEMP12","push #t","@END-IF-TEMP13","return"],"labelDict":{"@$1":3,"@$4":21,"@IF-TRUE-TEMP2":38,"@END-IF-TEMP3":46,"@IF-TRUE-TEMP0":48,"@END-IF-TEMP1":50,"@$18":53,"@IF-TRUE-TEMP4":68,"@END-IF-TEMP5":70,"@$26":73,"@OR-TRUE-TEMP6":86,"@END-OR-TEMP7":88,"@IF-TRUE-TEMP8":103,"@END-IF-TEMP9":105,"@$35":108,"@IF-TRUE-TEMP10":118,"@END-IF-TEMP11":120,"@$43":123,"@IF-TRUE-TEMP12":133,"@END-IF-TEMP13":135}};

    avm.newThread(testcase0);
    avm.newThread(testcase1);
    avm.newThread(testcase2);
    avm.newThread(testcase3);
    avm.newThread(testcase4);
    avm.newThread(testcase5);
    avm.newThread(testcase6);

    return avm;
}

var AVM = InitTestEnv();
var s = AVM.Scheduler(true);

function output(content) {
    document.getElementById('output').innerHTML += content;
}

function reset() {
    AVM = InitTestEnv();
    document.getElementById('asm').innerHTML = '';
    document.getElementById('fstack').innerHTML = '';
    document.getElementById('opstack').innerHTML = '';
    document.getElementById('closures').innerHTML = '';
    document.getElementById('output').innerHTML = '';
}
document.getElementById("reset").addEventListener("click", reset);
document.getElementById("onestep").addEventListener("click", ()=>{
    s.next();
});
document.getElementById("stepbystep").addEventListener("click", ()=>{
    AVM = InitTestEnv();
    s = AVM.Scheduler(true);
    setInterval(()=> {
        s.next();
    }, 0);
});
document.getElementById("execute").addEventListener("click", ()=>{
    document.getElementById('output').innerHTML = '';

    AVM = InitTestEnv();
    let s = AVM.Scheduler(false);

    s.next();
});

document.onkeydown = (event)=>{
    if(event && event.keyCode === 120){ // F9
        s.next();
    }
}; 

function Render(thread) {
    let tid = thread.tid;
    let env = thread.env;
    let asmlines = env.ASMLINES;
    let PC = env.PC;
    let FSTACK = env.FSTACK;
    let OPSTACK = env.OPSTACK;
    let CLOSURES = env.CLOSURES;
    let HEAP = env.HEAP;
    let POOL = env.POOL;
    let lineNum = PC;

    let currentClosureIndex = parseInt(env.currentClosureIndex.substring(1));

    document.getElementById('tid').innerHTML = tid;

    let html = new Array();
    let lines = asmlines;
    for(let i = 0; i < lines.length; i++) {
        if(lineNum === i) {
            html.push(`<p class="asm" id="asm${i}" style="color:#ff0000;background-color:#99eeff;"><span class="lineNum">${i}</span>${lines[i]}</p>`);
        }
        else {
            html.push(`<p class="asm" id="asm${i}" style="color:#000000;background-color:#ffffff;"><span class="lineNum">${i}</span>${lines[i]}</p>`);
        }
    }
    document.getElementById('asm').innerHTML = html.join('');

    // 显示栈和闭包
    let fstackDOM = document.getElementById('fstack');
    let opstackDOM = document.getElementById('opstack');
    let closuresDOM = document.getElementById('closures');
    let heapDOM = document.getElementById('heap');

    let fstackHTML = new Array();
    for(let i = FSTACK.length - 1; i >= 0; i--) {
        let frameTable = `<table class="closureTable"><tr><td>#</td><td>主调闭包</td><td>返回地址</td></tr><tr><td>${i}</td><td>${FSTACK[i].closure}</td><td>${FSTACK[i].returnTo}</td></tr></table>`;
        // fstackHTML.push(`${i}&nbsp;&nbsp;` + JSON.stringify(FSTACK[i]) + '<br>');
        fstackHTML.push(frameTable);
    }
    fstackDOM.innerHTML = fstackHTML.join('');

    let opstackHTML = new Array();
    for(let i = OPSTACK.length - 1; i >= 0; i--) {
        opstackHTML.push(`<span class="lineNum">${i}</span>` + OPSTACK[i] + '<br>');
    }
    opstackDOM.innerHTML = opstackHTML.join('');

    let closuresHTML = new Array();
    for(let i = CLOSURES.length - 1; i >= 0; i--) {
        let tableBg = '';
        if(currentClosureIndex === i) {
            tableBg = ' style="background-color:#eeeeee;font-weight:bold;"';
        }
        let closureTable = `<table class="closureTable"${tableBg}><tr><td>#</td><td>指令地址</td><td>上位闭包</td>`;
        let envSymbolHTML = new Array();
        let envValueHTML = new Array();
        for(let s in CLOSURES[i].env) {
            envSymbolHTML.push(`<td class="envSymbol">${s}</td>`);
            envValueHTML.push(`<td class="envValue">${(CLOSURES[i].env)[s]}</td>`);
        }
        closureTable += (envSymbolHTML.join('') +
                        `</tr><tr><td>${i}</td><td>${CLOSURES[i].instructionAddr}</td><td>${CLOSURES[i].parentClosure}</td>` + 
                        envValueHTML.join('') + '</tr></table>');
        // closuresHTML.push(`${i}&nbsp;&nbsp;` + JSON.stringify(CLOSURES[i]) + '<br>');
        closuresHTML.push(closureTable);
    }
    closuresDOM.innerHTML = closuresHTML.join('');

    let heapHTML = new Array();
    heapHTML.push(`<table class="closureTable">`);
    for(let i = 0; i < POOL.length; i++) {
        if(i % 10 === 0) {
            heapHTML.push(`<tr>`);
        }
        const REF_PREFIX = {
            "STRING":   "*",
            "SLIST":    "$",
            "LAMBDA":   "λ",
            "SYMBOL":   "!",
            "VARIABLE": "&",
            "CONSTANT": "#",
            "CLOSURE":  "^",
            "CONTINUATION":  "~",
        };
        heapHTML.push(`<td style="background-color:${(POOL[i] === undefined) ? "white" : "cyan"};min-width:0px;width:10px;height:10px;">${(POOL[i] === undefined) ? "" : REF_PREFIX[POOL[i].type]}&zwnj;</td>`);
        if(i % 10 === 15) {
            heapHTML.push(`</tr>`);
        }
    }
    for(let i = POOL.length; i < HEAP.length; i++) {
        if(i % 10 === 0) {
            heapHTML.push(`<tr>`);
        }
        heapHTML.push(`<td style="background-color:${(HEAP[i] === undefined) ? "white" : "yellow"};min-width:0px;width:10px;height:10px;">${(HEAP[i] === undefined) ? "" : HEAP[i].index}&zwnj;</td>`);
        if(i % 10 === 15) {
            heapHTML.push(`</tr>`);
        }
    }
    heapHTML.push(`</table>`);
    heapDOM.innerHTML = heapHTML.join('');
}


</script>
</body>
</html>
